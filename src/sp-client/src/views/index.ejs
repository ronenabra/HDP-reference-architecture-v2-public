<!DOCTYPE html>
<html>

<head>
    <title>Doctor's Portal (SP Client)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="container mt-5">
    <div class="header mb-4 d-flex justify-content-between align-items-center">
        <div>
            <h1>Doctor's Portal <small class="text-muted">Simulated Service Provider</small></h1>

            <form action="/" method="GET" class="d-inline-block ms-3">
                <label class="fw-bold me-2">Identity:</label>
                <select name="identity" class="form-select d-inline-block w-auto" onchange="this.form.submit()">
                    <% identities.forEach(function(id) { %>
                        <option value="<%= id %>" <%=id===currentIdentity ? 'selected' : '' %>><%= id %>
                        </option>
                        <% }); %>
                </select>
            </form>
        </div>

        <div class="btn-group">
            <a href="/manage?identity=<%= currentIdentity %>" class="btn btn-sm btn-outline-primary">Manage Org</a>
            <a href="http://localhost:4000/logs-view" class="btn btn-sm btn-outline-dark" target="_blank">System
                Logs</a>
            <form action="/reset" method="POST" class="d-inline">
                <button class="btn btn-sm btn-outline-danger ms-2">Reset All</button>
            </form>
        </div>
    </div>

    <% if (flash) { %>
        <div
            class="alert alert-<%= flash.type === 'error' ? 'danger' : (flash.type === 'success' ? 'success' : 'info') %>">
            <%= flash.message %>
        </div>
        <% } %>

            <div class="row">
                <!-- CREATE REQUEST -->
                <div class="col-md-4">
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">Create Request</div>
                        <div class="card-body">
                            <form action="/create-consent" method="POST">
                                <input type="hidden" name="identity" value="<%= currentIdentity %>">
                                <div class="mb-3">
                                    <label class="form-label">Patient National ID</label>
                                    <input type="text" name="patientId" class="form-control" value="123456789" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Request Consent</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- LIST CONSENTS -->
                <div class="col-md-8">
                    <h4 class="mb-3">Active Consents (<%= consents.length %>)</h4>

                    <% if (consents.length===0) { %>
                        <div class="alert alert-info">No local consents found. Use the manual sandbox below or create a
                            request.</div>
                        <% } %>

                            <% consents.forEach(function(item) { %>
                                <div class="card mb-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <span><strong>Stored Consent</strong></span>
                                        <span
                                            class="badge bg-<%= item.consent && item.consent.status === 'active' ? 'success' : (item.consent && item.consent.status === 'rejected' ? 'danger' : 'warning') %>">
                                            <%= item.consent ? item.consent.status : 'unknown' %>
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <% if (item.validationError) { %>
                                            <div class="alert alert-danger py-1 px-2 mb-2">
                                                <small><strong>Error:</strong>
                                                    <%= item.validationError %>
                                                </small>
                                            </div>
                                            <% } %>

                                                <% if (item.data) { %>
                                                    <!-- Data View Mode -->
                                                    <div class="bg-light p-2 border rounded mb-2"
                                                        style="max-height: 200px; overflow: auto;">
                                                        <pre
                                                            class="m-0 small"><%= JSON.stringify(item.data, null, 2) %></pre>
                                                    </div>
                                                    <div class="text-success small fw-bold">Data Fetched Successfully
                                                    </div>
                                                    <!-- Reset Button to go back to edit mode? For now, just show data or allow fetch again -->
                                                    <hr>
                                                    <% } %>

                                                        <!-- Unified Form -->
                                                        <form method="POST">
                                                            <input type="hidden" name="identity"
                                                                value="<%= currentIdentity %>">

                                                            <div class="mb-2">
                                                                <label class="form-label small fw-bold">Consent ID
                                                                    (Editable):</label>
                                                                <input type="text" name="consentId"
                                                                    class="form-control form-control-sm"
                                                                    value="<%= item.id %>">
                                                            </div>

                                                            <div class="mb-2">
                                                                <label class="form-label small fw-bold">Target Endpoint
                                                                    (Editable):</label>
                                                                <input type="text" name="endpointUrl"
                                                                    class="form-control form-control-sm"
                                                                    placeholder="Resolved endpoint will appear here..."
                                                                    value="<%= item.consent?.discoveredEndpoint || '' %>">
                                                            </div>

                                                            <div class="d-flex gap-2">
                                                                <button type="submit" formaction="/discover"
                                                                    class="btn btn-sm btn-info text-white flex-grow-1">
                                                                    1. Check Status / Discover
                                                                </button>
                                                                <button type="submit" formaction="/fetch-data"
                                                                    class="btn btn-sm btn-success flex-grow-1">
                                                                    2. Fetch Data
                                                                </button>
                                                            </div>
                                                        </form>
                                    </div>
                                </div>
                                <% }); %>

                                    <!-- MANUAL SANDBOX CARD -->
                                    <div class="card border-warning mb-3">
                                        <div class="card-header bg-warning text-dark">
                                            <strong>Manual Sandbox</strong> (Test Arbitrary IDs)
                                        </div>
                                        <div class="card-body">
                                            <form method="POST">
                                                <input type="hidden" name="identity" value="<%= currentIdentity %>">

                                                <div class="mb-2">
                                                    <label class="form-label small fw-bold">Consent ID:</label>
                                                    <input type="text" name="consentId"
                                                        class="form-control form-control-sm" placeholder="e.g. uuid...">
                                                </div>

                                                <div class="mb-2">
                                                    <label class="form-label small fw-bold">Target Endpoint:</label>
                                                    <input type="text" name="endpointUrl"
                                                        class="form-control form-control-sm" placeholder="https://...">
                                                </div>

                                                <div class="d-flex gap-2">
                                                    <button type="submit" formaction="/discover"
                                                        class="btn btn-sm btn-info text-white flex-grow-1">
                                                        Check / Discover
                                                    </button>
                                                    <button type="submit" formaction="/fetch-data"
                                                        class="btn btn-sm btn-success flex-grow-1">
                                                        Fetch Data
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                </div>
            </div>
</body>

</html>